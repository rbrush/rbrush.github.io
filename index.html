
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Too Much Code</title>
  <meta name="author" content="Ryan Brush">

  
  <meta name="description" content="Recently I&rsquo;ve focused on retaking rules for developers, where rules aim to be a developer-friendly way to untagle complex logic. Yet some &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.toomuchcode.org">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Too Much Code" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-2927953-1', 'auto');
    ga('send', 'pageview');

  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Too Much Code</a></h1>
  
    <h2>Not enough cohesion</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/rbrush" rel="subscribe-github" title="@rbrush on GitHub" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
<ul class="subscribe">
  <li><a href="https://twitter.com/ryanbrush" rel="subscribe-twitter" title="@ryanbrush on Twitter" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 512 512"><path class="social" d="M0.001,334.932c33.327,30.816,118.891,59.981,188.517-8.271c-12.52,1.955-22.972-0.416-30.913-8.269
  c-7.531-7.465-7.945-15.182-3.914-22.202c3.275-5.725,10.184-9.741,16.977-13.934c-12.323,2.285-22.829,1.095-32.218-3.706
  c-12.604-6.444-24.863-13.228-28.3-27.207c7.71-8.112,16.28-15.359,34.831-12.627c-17.45-5.83-33.087-13.429-44.41-24.815
  c-11.028-11.091-12.163-18.302-13.932-26.996c9.632-3.567,19.688-5.421,30.478-4.353c-24.397-12.476-34.757-29.63-40.487-48.325
  c-1.731-5.652-2.044-11.03-1.31-16.545c98.826,37.305,145.11,64.109,170.662,89.251c11.496-30.589,38.3-99.868,78.371-123.646
  c0.191,3.77-1.309,7.837-4.357,12.189c11.863-6.609,21.125-17.188,37.445-16.98c-1.879,7.723-7.279,13.904-17.85,17.854
  c10.662-4.084,21.463-7.545,32.65-9.578c10.375-1.881,10.229,6.304,4.355,10.444c-11.916,8.412-24.578,9.456-37.006,13.498
  c38.105,0.949,69.266,18.994,93.604,58.343c8.088,13.074,13.52,26.149,14.807,40.487c16.254,4.563,32.426,5.494,48.76,2.61
  c4.475-0.796,8.645-1.63,12.627-3.482c-6.354,9.529-13.686,17.356-23.947,20.899c-9.811,3.387-19.637,6.688-30.473,6.968
  c17.641,6.675,37.082,7.045,57.033,5.659c-24.402,23.486-43.08,22.922-61.824,22.642c-8.221,34.703-25.025,69.315-60.52,101.005
  c-46.559,41.569-96.678,61.397-148.457,65.742c-48.552,4.07-95.488,3.512-146.726-20.464
  C56.486,393.349,24.648,368.884,0.001,334.932L0.001,334.932z"/></svg></a></li>
</ul>
  
  
  
  
  
  
    
      <form action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="sitesearch" value="www.toomuchcode.org" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/14/insta-declarative-dsls/">Insta-Declarative DSLs!</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&rsquo;ve focused on <a href="https://www.youtube.com/watch?v=Z6oVuYmRgkk">retaking rules for developers</a>, where rules aim to be a developer-friendly way to untagle complex logic. Yet some problems call for policy changes without the involvement of developers. We need a simple way to write simple rules.</p>

<p>One approach is to offer a minimal Domain-Specific Language focused on the policy our users need to change. In this post we take a simple example, write a DSL, parse it, validate it, and run it against some data. We&rsquo;ll use the excellent <a href="https://github.com/Engelberg/instaparse">Instaparse</a> library to define the grammar and create the parse tree, and convert that tree into rules executable with <a href="http://www.clara-rules.org">Clara</a>.</p>

<p>First we figure out how we want our DSL to look. To keep things simple, let&rsquo;s imagine a retail setting and let our business user define promotions and discounts based on customer and order information. An example might look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="nv">discount</span> <span class="nv">my-discount</span> <span class="mi">15</span> <span class="nb">when </span><span class="nv">customer</span> <span class="nv">status</span> <span class="nv">is</span> <span class="nv">platinum.</span>
</span><span class='line'><span class="nv">discount</span> <span class="nv">extra-discount</span> <span class="mi">10</span> <span class="nb">when </span><span class="nv">customer</span> <span class="nv">status</span> <span class="nv">is</span> <span class="nv">gold</span> <span class="nb">and </span><span class="nv">total</span> <span class="nv">value</span> <span class="nb">&gt; </span><span class="mi">200</span><span class="nv">.</span>
</span><span class='line'><span class="nv">promotion</span> <span class="nv">free-widget-month</span> <span class="nv">free-widget</span> <span class="nb">when </span><span class="nv">customer</span> <span class="nv">status</span> <span class="nv">is</span> <span class="nv">gold</span> <span class="nb">and </span><span class="nv">order</span> <span class="nv">month</span> <span class="nv">is</span> <span class="nv">august.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rule engines are a good fit for declarative DSLs because rule engines <em>themselves</em> are declarative. We can see the rule-like structure in the above example: apply this policy when that set of conditions is true.</p>

<p>Now we need to write a function that converts our friendly DSL into rules we can run. Fortunately, in Clara <a href="/blog/2014/01/19/rules-as-data/">rules are data</a>, so our function needs to produce a simple data structure rather than generating rules using string manipulation. Using Clojure and <a href="https://github.com/Prismatic/schema">Prismatic Schema</a> to define the structure, our function looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">s/defn</span> <span class="nv">load-user-rules</span> <span class="ss">:-</span> <span class="p">[</span><span class="nv">clara.rules.schema/Production</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Converts a business rule string into Clara productions.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">business-rules</span> <span class="ss">:-</span> <span class="nv">s/Str</span><span class="p">]</span>
</span><span class='line'>  <span class="c1">;; TODO: convert DSL to Clara rule structures.</span>
</span><span class='line'>  <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s implement it! First we use <a href="https://github.com/Engelberg/instaparse">Instaparse</a> to define our grammar. We can start with the major productions and break their contents. So the discount production would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="nv">DISCOUNT</span> <span class="nb">= </span><span class="nv">&lt;</span><span class="ss">&#39;discount&#39;&gt;</span> <span class="nv">NAME</span> <span class="nv">PERCENT</span> <span class="nv">&lt;</span><span class="ss">&#39;when&#39;&gt;</span> <span class="nv">CONDITION</span> <span class="p">[</span><span class="nv">&lt;</span><span class="ss">&#39;and&#39;&gt;</span> <span class="nv">CONDITION</span><span class="p">]</span><span class="nb">* </span><span class="nv">&lt;</span><span class="ss">&#39;.&#39;&gt;</span><span class="c1">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it contains a series of conditions, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="nv">CONDITION</span> <span class="nb">= </span><span class="nv">FACTTYPE</span> <span class="nv">FIELD</span> <span class="nv">OPERATOR</span> <span class="nv">VALUE</span> <span class="c1">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And so on. Here is the complete grammar we will use, which we simply bring into our Clojure session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">instaparse.core</span> <span class="ss">:as</span> <span class="nv">insta</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">shopping-grammar</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insta/parser</span>
</span><span class='line'>   <span class="s">&quot;&lt;RULES&gt; = [DISCOUNT | PROMOTION]+</span>
</span><span class='line'><span class="s">    PROMOTION = &lt;&#39;promotion&#39;&gt; NAME PROMOTIONTYPE &lt;&#39;when&#39;&gt; CONDITION [&lt;&#39;and&#39;&gt; CONDITION]* &lt;&#39;.&#39;&gt;;</span>
</span><span class='line'><span class="s">    DISCOUNT = &lt;&#39;discount&#39;&gt; NAME PERCENT &lt;&#39;when&#39;&gt; CONDITION [&lt;&#39;and&#39;&gt; CONDITION]* &lt;&#39;.&#39;&gt;;</span>
</span><span class='line'><span class="s">    &lt;PERCENT&gt; = NUMBER ;</span>
</span><span class='line'><span class="s">    PROMOTIONTYPE = STRING ;</span>
</span><span class='line'><span class="s">    &lt;NAME&gt; = STRING ;</span>
</span><span class='line'><span class="s">    NUMBER = #&#39;[0-9]+&#39; ;</span>
</span><span class='line'><span class="s">    &lt;STRING&gt; = #&#39;[A-Za-z][A-Za-z0-9_-]+&#39; ;</span>
</span><span class='line'><span class="s">    CONDITION = FACTTYPE FIELD OPERATOR VALUE ;</span>
</span><span class='line'><span class="s">    FACTTYPE = &#39;customer&#39; | &#39;total&#39; | &#39;order&#39; ;</span>
</span><span class='line'><span class="s">    &lt;FIELD&gt; = STRING ;</span>
</span><span class='line'><span class="s">    OPERATOR = &#39;is&#39; | &#39;&gt;&#39; | &#39;&lt;&#39; | &#39;=&#39; ;</span>
</span><span class='line'><span class="s">    &lt;VALUE&gt; = STRING | NUMBER ;</span>
</span><span class='line'><span class="s">    &quot;</span>
</span><span class='line'>   <span class="ss">:auto-whitespace</span> <span class="ss">:standard</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The of angle brackets indicate productions to omit from the abstract syntax tree and replace by their children. This isn&rsquo;t strictly necessary, but simplifies things when transform the tree.</p>

<p>The <code>insta-parser</code> function actually returns a function that converts an input to the syntax tree! So we can just call it with our DSL and pretty-print the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">clojure.pprint/pprint</span>
</span><span class='line'> <span class="p">(</span><span class="nf">shopping-grammar</span>
</span><span class='line'>  <span class="s">&quot;discount my-discount 15 when customer status is platinum.</span>
</span><span class='line'><span class="s">   discount extra-discount 10 when customer status is gold and total value &gt; 200.</span>
</span><span class='line'><span class="s">   promotion free-widget-month free-widget when customer status is gold and order month is august.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which produces this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">([</span><span class="ss">:DISCOUNT</span>
</span><span class='line'>  <span class="s">&quot;my-discount&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:NUMBER</span> <span class="s">&quot;15&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:CONDITION</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:FACTTYPE</span> <span class="s">&quot;customer&quot;</span><span class="p">]</span>
</span><span class='line'>   <span class="s">&quot;status&quot;</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:OPERATOR</span> <span class="s">&quot;is&quot;</span><span class="p">]</span>
</span><span class='line'>   <span class="s">&quot;platinum&quot;</span><span class="p">]]</span>
</span><span class='line'> <span class="p">[</span><span class="ss">:DISCOUNT</span>
</span><span class='line'>  <span class="s">&quot;extra-discount&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:NUMBER</span> <span class="s">&quot;10&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:CONDITION</span> <span class="p">[</span><span class="ss">:FACTTYPE</span> <span class="s">&quot;customer&quot;</span><span class="p">]</span> <span class="s">&quot;status&quot;</span> <span class="p">[</span><span class="ss">:OPERATOR</span> <span class="s">&quot;is&quot;</span><span class="p">]</span> <span class="s">&quot;gold&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:CONDITION</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:FACTTYPE</span> <span class="s">&quot;total&quot;</span><span class="p">]</span>
</span><span class='line'>   <span class="s">&quot;value&quot;</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:OPERATOR</span> <span class="s">&quot;&gt;&quot;</span><span class="p">]</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:NUMBER</span> <span class="s">&quot;200&quot;</span><span class="p">]]]</span>
</span><span class='line'> <span class="p">[</span><span class="ss">:PROMOTION</span>
</span><span class='line'>  <span class="s">&quot;free-widget-month&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:PROMOTIONTYPE</span> <span class="s">&quot;free-widget&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:CONDITION</span> <span class="p">[</span><span class="ss">:FACTTYPE</span> <span class="s">&quot;customer&quot;</span><span class="p">]</span> <span class="s">&quot;status&quot;</span> <span class="p">[</span><span class="ss">:OPERATOR</span> <span class="s">&quot;is&quot;</span><span class="p">]</span> <span class="s">&quot;gold&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:CONDITION</span> <span class="p">[</span><span class="ss">:FACTTYPE</span> <span class="s">&quot;order&quot;</span><span class="p">]</span> <span class="s">&quot;month&quot;</span> <span class="p">[</span><span class="ss">:OPERATOR</span> <span class="s">&quot;is&quot;</span><span class="p">]</span> <span class="s">&quot;august&quot;</span><span class="p">]])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just for fun, let&rsquo;s see what happens when a user mistypes some input. Let&rsquo;s say &ldquo;customer&rdquo; is misspelled when we evaluate the input against our grammar. So running this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">println</span>
</span><span class='line'> <span class="p">(</span><span class="nf">shopping-grammar</span>
</span><span class='line'>  <span class="s">&quot;discount my-discount 15 when customeer status is platinum.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>prints out this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="nv">Parse</span> <span class="nv">error</span> <span class="nv">at</span> <span class="nv">line</span> <span class="mi">1</span>, <span class="nv">column</span> <span class="mi">30</span><span class="err">:</span>
</span><span class='line'><span class="nv">discount</span> <span class="nv">my-discount</span> <span class="mi">15</span> <span class="nb">when </span><span class="nv">customeer</span> <span class="nv">status</span> <span class="nv">is</span> <span class="nv">platinum.</span>
</span><span class='line'>                             <span class="o">^</span>
</span><span class='line'><span class="nv">Expected</span> <span class="nv">one</span> <span class="nv">of</span><span class="err">:</span>
</span><span class='line'><span class="nv">order</span>
</span><span class='line'><span class="nv">total</span>
</span><span class='line'><span class="nv">customer</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great! The error is pretty clear and gives the user options how to fix it. Instaparse does a great job at this.</p>

<p>Alright, let&rsquo;s get back on track and imagine our user fixed the error. We now have a nice parse tree&hellip;we just need to convert it into rules. One way to do this is write a <code>map</code> function that goes through each top-level production and returns a Clara rule. This is a fine approach, and may be a better fit depending on the transformation needed. But in this case I&rsquo;m going to take advantage of another feature of Instaparse: the ability to apply arbitrary transformations to productions in the tree.</p>

<p>The simplest example is we want to replace productions like [:NUMBER &ldquo;15&rdquo;] with&hellip;the actual number 15. This tends to be useful for things like, you know, math.</p>

<p>So let&rsquo;s run a production through our grammar and use the <code>insta/transform</code> function to take a map of transformation for productions. We use Clojure&rsquo;s threading macro to make wiring functions together more readable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="s">&quot;discount my-discount 15 when customer status is platinum.&quot;</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">shopping-grammar</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">insta/transform</span> <span class="p">{</span><span class="ss">:NUMBER</span> <span class="o">#</span><span class="p">(</span><span class="nf">Integer/parseInt</span> <span class="nv">%</span><span class="p">)})</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">clojure.pprint/pprint</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This transforms our tree into this, where we have a number rather than an AST production:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">([</span><span class="ss">:DISCOUNT</span>
</span><span class='line'>  <span class="s">&quot;my-discount&quot;</span>
</span><span class='line'>  <span class="mi">15</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:CONDITION</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:FACTTYPE</span> <span class="s">&quot;customer&quot;</span><span class="p">]</span>
</span><span class='line'>   <span class="s">&quot;status&quot;</span>
</span><span class='line'>   <span class="p">[</span><span class="ss">:OPERATOR</span> <span class="s">&quot;is&quot;</span><span class="p">]</span>
</span><span class='line'>   <span class="s">&quot;platinum&quot;</span><span class="p">]])</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>So we&rsquo;ve taken our first step of transforming our tree into an actual, executable rule! Now we need to do some more transformations:</p>

<ul>
<li><code>:OPERATOR</code> gets transformed to a Clojure comparison function</li>
<li><code>:FACTTYPE</code> gets transformed to a Clojure type. In this case we just use Clojure records.</li>
<li><code>:PROMOTIONTYPE</code> is an enumeration, which we idiomatically transform to a Clojure keyword</li>
<li><code>:CONDITION</code> gets transformed into the left-hand side expression of a rule</li>
<li><code>:DISCOUNT</code> and <code>:PRODUCTION</code> get transformed into actual Clara rules, built on the transformations above! These match the <code>clara.rules.schema/Production</code> Prismatic Schema.</li>
</ul>


<p>I find it&rsquo;s best to build this type of logic from the bottom up in a REPL or a REPL-connected editor. Just start with the simplest transformations, like <code>:NUMBER</code> and <code>:OPERATOR</code>, make sure they work in the REPL, then work on the transformations that use them. I also found myself tweaking the grammar to omit or hide unnecessary productions. After a few quick iterations I ended up with this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">operators</span> <span class="p">{</span><span class="s">&quot;is&quot;</span> <span class="o">`</span><span class="nv">=</span>
</span><span class='line'>                <span class="s">&quot;&gt;&quot;</span> <span class="o">`</span><span class="nv">&gt;</span>
</span><span class='line'>                <span class="s">&quot;&lt;&quot;</span> <span class="o">`</span><span class="nv">&lt;</span>
</span><span class='line'>                <span class="s">&quot;=&quot;</span> <span class="o">`</span><span class="nv">=</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">fact-types</span>
</span><span class='line'>  <span class="p">{</span><span class="s">&quot;customer&quot;</span> <span class="nv">Customer</span>
</span><span class='line'>   <span class="s">&quot;total&quot;</span> <span class="nv">Total</span>
</span><span class='line'>   <span class="s">&quot;order&quot;</span> <span class="nv">Order</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">shopping-transforms</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:NUMBER</span> <span class="o">#</span><span class="p">(</span><span class="nf">Integer/parseInt</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>   <span class="ss">:OPERATOR</span> <span class="nv">operators</span>
</span><span class='line'>   <span class="ss">:FACTTYPE</span> <span class="nv">fact-types</span>
</span><span class='line'>   <span class="ss">:CONDITION</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">fact-type</span> <span class="nv">field</span> <span class="nv">operator</span> <span class="nv">value</span><span class="p">]</span>
</span><span class='line'>                <span class="p">{</span><span class="ss">:type</span> <span class="nv">fact-type</span>
</span><span class='line'>                 <span class="ss">:constraints</span> <span class="p">[(</span><span class="nb">list </span><span class="nv">operator</span> <span class="p">(</span><span class="nb">symbol </span><span class="nv">field</span><span class="p">)</span> <span class="nv">value</span><span class="p">)]})</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;; Convert promotion strings to keywords.</span>
</span><span class='line'>   <span class="ss">:PROMOTIONTYPE</span> <span class="nv">keyword</span>
</span><span class='line'>
</span><span class='line'>   <span class="ss">:DISCOUNT</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">name </span><span class="nv">percent</span> <span class="o">&amp;</span> <span class="nv">conditions</span><span class="p">]</span>
</span><span class='line'>               <span class="p">{</span><span class="ss">:name</span> <span class="nv">name</span>
</span><span class='line'>                <span class="ss">:lhs</span> <span class="nv">conditions</span>
</span><span class='line'>                <span class="ss">:rhs</span> <span class="o">`</span><span class="p">(</span><span class="nf">insert!</span> <span class="p">(</span><span class="nf">-&gt;Discount</span> <span class="o">~</span><span class="nb">name </span><span class="o">~</span><span class="nv">percent</span><span class="p">))})</span>
</span><span class='line'>
</span><span class='line'>   <span class="ss">:PROMOTION</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">name </span><span class="nv">promotion-type</span> <span class="o">&amp;</span> <span class="nv">conditions</span><span class="p">]</span>
</span><span class='line'>                <span class="p">{</span><span class="ss">:name</span> <span class="nv">name</span>
</span><span class='line'>                 <span class="ss">:lhs</span> <span class="nv">conditions</span>
</span><span class='line'>                 <span class="ss">:rhs</span> <span class="o">`</span><span class="p">(</span><span class="nf">insert!</span> <span class="p">(</span><span class="nf">-&gt;Promotion</span> <span class="o">~</span><span class="nb">name </span><span class="o">~</span><span class="nv">promotion-type</span><span class="p">))})})</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! This works because the transformations build on top of lower-level transformations. For instance, the <code>:CONDITION</code> transformation is given a fact-type and an operator because those were transformed by the <code>:FACTTYPE</code> and <code>:OPERATOR</code> transformations, respectively. Users could choose to leave out lower-level transformations and have <code>:CONDITION</code> do all of the work, but the above approach shows the power of this Instaparse feature.</p>

<p>Also note our use of the Clojure syntax quote (`) and unquote (~). These are typically used when writing Macros, but they&rsquo;re convenient in this case to build expressions that Clara turns into rules. (After all, Clara is really just a big macro that converts user expressions into a rete network!)</p>

<p>Now let&rsquo;s run this set of transformations against our input data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="s">&quot;discount my-discount 15 when customer status is platinum.</span>
</span><span class='line'><span class="s">      discount extra-discount 10 when customer status is gold and total value &gt; 200.</span>
</span><span class='line'><span class="s">      promotion free-widget-month free-widget when customer status is gold and order month is august.&quot;</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">shopping-grammar</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">insta/transform</span> <span class="nv">shopping-transforms</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">clojure.pprint/pprint</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This produces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">({</span><span class="ss">:name</span> <span class="s">&quot;my-discount&quot;</span>,
</span><span class='line'>  <span class="ss">:lhs</span>
</span><span class='line'>  <span class="p">({</span><span class="ss">:type</span> <span class="nv">clara.examples.insta.Customer</span>,
</span><span class='line'>    <span class="ss">:constraints</span> <span class="p">[(</span><span class="nf">clojure.core/=</span> <span class="nv">status</span> <span class="s">&quot;platinum&quot;</span><span class="p">)]})</span>,
</span><span class='line'>  <span class="ss">:rhs</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">clara.rules/insert!</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">clara.examples.insta/-&gt;Discount</span> <span class="s">&quot;my-discount&quot;</span> <span class="mi">15</span><span class="p">))}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;extra-discount&quot;</span>,
</span><span class='line'>  <span class="ss">:lhs</span>
</span><span class='line'>  <span class="p">({</span><span class="ss">:type</span> <span class="nv">clara.examples.insta.Customer</span>,
</span><span class='line'>    <span class="ss">:constraints</span> <span class="p">[(</span><span class="nf">clojure.core/=</span> <span class="nv">status</span> <span class="s">&quot;gold&quot;</span><span class="p">)]}</span>
</span><span class='line'>   <span class="p">{</span><span class="ss">:type</span> <span class="nv">clara.examples.insta.Total</span>,
</span><span class='line'>    <span class="ss">:constraints</span> <span class="p">[(</span><span class="nf">clojure.core/&gt;</span> <span class="nv">value</span> <span class="mi">200</span><span class="p">)]})</span>,
</span><span class='line'>  <span class="ss">:rhs</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">clara.rules/insert!</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">clara.examples.insta/-&gt;Discount</span> <span class="s">&quot;extra-discount&quot;</span> <span class="mi">10</span><span class="p">))}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;free-widget-month&quot;</span>,
</span><span class='line'>  <span class="ss">:lhs</span>
</span><span class='line'>  <span class="p">({</span><span class="ss">:type</span> <span class="nv">clara.examples.insta.Customer</span>,
</span><span class='line'>    <span class="ss">:constraints</span> <span class="p">[(</span><span class="nf">clojure.core/=</span> <span class="nv">status</span> <span class="s">&quot;gold&quot;</span><span class="p">)]}</span>
</span><span class='line'>   <span class="p">{</span><span class="ss">:type</span> <span class="nv">clara.examples.insta.Order</span>,
</span><span class='line'>    <span class="ss">:constraints</span> <span class="p">[(</span><span class="nf">clojure.core/=</span> <span class="nv">month</span> <span class="s">&quot;august&quot;</span><span class="p">)]})</span>,
</span><span class='line'>  <span class="ss">:rhs</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">clara.rules/insert!</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">clara.examples.insta/-&gt;Promotion</span>
</span><span class='line'>    <span class="s">&quot;free-widget-month&quot;</span>
</span><span class='line'>    <span class="ss">:free-widget</span><span class="p">))})</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Now we have a sequence of rules we can run! We can pass this directly into the <a href="http://www.clara-rules.org/apidocs/0.9.0/clojure/clara.rules.html#var-mk-session">mk-session</a> function and create an actual rule session!</p>

<p>We can also combine these rules with others written by Clara&rsquo;s <a href="http://www.clara-rules.org/apidocs/0.9.0/clojure/clara.rules.html#var-defrule">defrule</a> or generated from some other source. You can see the full code in the <a href="https://github.com/rbrush/clara-examples/blob/master/src/main/clojure/clara/examples/insta.clj">clara.examples.insta</a> namespace in the clara-examples project, but here is the pertinent segment for running our rules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">session</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">mk-session</span> <span class="ss">&#39;clara.examples.insta</span> <span class="p">(</span><span class="nf">load-user-rules</span> <span class="nv">example-rules</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">-&gt;Customer</span> <span class="s">&quot;gold&quot;</span><span class="p">)</span>
</span><span class='line'>                          <span class="p">(</span><span class="nf">-&gt;Order</span> <span class="mi">2013</span> <span class="s">&quot;august&quot;</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'>                          <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">20</span> <span class="ss">:gizmo</span><span class="p">)</span>
</span><span class='line'>                          <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">120</span> <span class="ss">:widget</span><span class="p">)</span>
</span><span class='line'>                          <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">90</span> <span class="ss">:widget</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">fire-rules</span><span class="p">))]</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="nf">clojure.pprint/pprint</span> <span class="p">(</span><span class="nf">query</span> <span class="nv">session</span> <span class="nv">get-discounts</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">clojure.pprint/pprint</span> <span class="p">(</span><span class="nf">query</span> <span class="nv">session</span> <span class="nv">get-promotions</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this produces the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">({</span><span class="ss">:?discount</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;extra-discount&quot;</span>, <span class="ss">:percent</span> <span class="mi">10</span><span class="p">}})</span>
</span><span class='line'><span class="p">({</span><span class="ss">:?discount</span> <span class="p">{</span><span class="ss">:reason</span> <span class="s">&quot;free-widget-month&quot;</span>, <span class="ss">:type</span> <span class="ss">:free-widget</span><span class="p">}})</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s it! The complete code for this is in <a href="https://github.com/rbrush/clara-examples/blob/master/src/main/clojure/clara/examples/insta.clj">clara-examples</a>. Details on Instaparse can be found on the <a href="https://github.com/Engelberg/instaparse">Instaparse github page</a> and Clara documentation is at <a href="http://www.clara-rules.org">clara-rules.org</a>. You can also reach me on twitter <a href="https://twitter.com/ryanbrush">@ryanbrush</a>.</p>

<p>Finally, we once again see how powerful Clojure&rsquo;s composable design is. The Instaparse and Clara libraries were built completely independently, but since both use functional transformations of immutable data structures we were able to combine them to create something useful in a small amount of code. Plus hacking on this stuff is just plain <em>fun</em>.</p>

<p>UPDATE: I posted an answer to a follow up question to <a href="https://groups.google.com/forum/#!topic/clara-rules/ME7CKVdBMqg">this thread in the Clara Google group</a>. If there are other topics, please feel free to use that thread or create a new one.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/11/clara-rules-site/">Clara Rules Site</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Anyone looking for information related to Clara should check out the new <a href="http://www.clara-rules.org">clara-rules.org</a> site. Complete developer documentation and resources are there.</p>

<p>Updates to Clara are posted to the <a href="https://groups.google.com/forum/#!forum/clara-rules">Clara Google Group</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/16/micro-bench-macro-optimize/">Micro Benchmarks versus Macro Optimizations in Clojure</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&rsquo;s a simple question Clojure users hear often:</p>

<blockquote><p>What is the overhead of Clojure&rsquo;s persistent data structures?</p></blockquote>

<p>I ran into this question headlong when profiling and tuning <a href="https://github.com/rbrush/clara-rules">Clara</a>. Clara aims to draw ideas from expert systems into the Clojure ecosystem, making them available as first-class Clojure idioms. Therefore Clara&rsquo;s working memory works like other Clojure data structures: it is immutable and &ldquo;updates&rdquo; create a new, immutable working memory.</p>

<p>Anyone skeptical of the benefits of immutability should go watch Rich Hickey&rsquo;s talks like <a href="http://www.infoq.com/presentations/Simple-Made-Easy">Simple Made Easy</a>. Yet these advantages are irrelevant if they don&rsquo;t perform well enough. So we have a challenge: we know that persistent Clojure structures will lose a micro benchmark comparison to mutable counterparts, but can we balance that with macro optimizations made possible with immutability? The answer is <em>yes</em>, with the techniques below working for Clara and probably for many other projects.</p>

<h2>Optimizing Clojure Code</h2>

<p>Optimizations should have an objective. My objective with Clara was to make performance at least competitive with latest version of Drools, which may be used to solve similar problems. Clara&rsquo;s basis in Clojure offers a number of advantages, but we need to make sure performance isn&rsquo;t a barrier. So I created the <a href="https://github.com/rbrush/clara-benchmark">clara-benchmark</a> project, using <a href="https://github.com/hugoduncan/criterium">Criterium</a> to benchmark a number of flows in both Clara and Drools. Some findings:</p>

<h3>It&rsquo;s All About the Algorithms</h3>

<p>The first run of profiling didn&rsquo;t look good. Clara was almost ten times slower than Drools for some cases. But it turns out the bulk of this cost had nothing to do with Clojure &mdash; my variation of the Rete algorithm was inefficient, indexing facts for join operations that could never occur due to the nature of the rules. In short, my algorithm sucked.</p>

<p>The good news this was easily exposed with a profiling tool and fixed with little effort. I find algorithms in a language like Clojure to be easier to understand and tune because they are expressed as simple transformations of data. We know the structures we receive and return, and simply need to identify the most efficient way to express the transformation. This is a major contrast to systems that force us keep track of a bunch of additional state when working through the system.</p>

<p>A better algorithm was the biggest single improvement, bringing Clara within twice Drools performance or better for the use cases tested. But we&rsquo;re not done yet.</p>

<h3>Strongly Isolated Mutability</h3>

<p>A better algorithm got us close, but further profiling revealed a bottleneck for some use cases. Rete engines often perform joins over common facts, like this simple example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nf">defquery</span> <span class="nv">orders-by-customer-id</span>
</span><span class='line'>  <span class="s">&quot;Returns the orders for the given customer.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:?id</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">Order</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?id</span> <span class="nv">customerId</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?total</span> <span class="nv">total</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">Customer</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?id</span> <span class="nv">id</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>This queries the working memory to simply find customer and orders with the same id. (See the <a href="https://github.com/rbrush/clara-rules/wiki/Guide">Clara documentation</a> for details on use.)</p>

<p>Clara makes extensive use of Clojure&rsquo;s <code>group-by</code> function to group collections of facts by matching keys. After tuning my algorithm, I discovered that some benchmarks were spending the bulk of their time in <code>group-by</code>. The <code>group-by</code> implementation can be found in <a href="https://github.com/clojure/clojure/blob/master/src/clj/clojure/core.clj">the Clojure source</a>, but here it is for convenience:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">group-by</span>
</span><span class='line'>  <span class="s">&quot;Returns a map of the elements of coll keyed by the result of</span>
</span><span class='line'><span class="s">  f on each element. The value at each key will be a vector of the</span>
</span><span class='line'><span class="s">  corresponding elements, in the order they appeared in coll.&quot;</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:added</span> <span class="s">&quot;1.2&quot;</span>
</span><span class='line'>   <span class="ss">:static</span> <span class="nv">true</span><span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">f</span> <span class="nv">coll</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">persistent!</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">reduce</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ret</span> <span class="nv">x</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">k</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">assoc!</span> <span class="nv">ret</span> <span class="nv">k</span> <span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="nb">get </span><span class="nv">ret</span> <span class="nv">k</span> <span class="p">[])</span> <span class="nv">x</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">transient</span> <span class="p">{})</span> <span class="nv">coll</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the use of Clojure transients, which are mutable structures designed to be used locally for efficiency. Clojure takes a pragmatic step here. The goal is to keep our systems easy to reason about, and we can achieve that if no external observer can detect mutability. <code>group-by</code> is a pure function working with immutable structures for all observers, but gains performance by using transients internally.</p>

<p>The trouble I ran into with my benchmarks is that I had many items mapping to the same key. Notice that Clojure&rsquo;s group-by uses a transient map, but that map contains non-transient vectors. So the performance bottleneck arose because this group-by function wasn&rsquo;t &ldquo;transient enough&rdquo; for my particular data.</p>

<p>I worked around this by writing an alternate group-by that better fit my needs. Its internals are hideous but are the result of profiling a couple implementations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">tuned-group-by</span>
</span><span class='line'>  <span class="s">&quot;Equivalent of the built-in group-by, but tuned for when</span>
</span><span class='line'><span class="s">   there are many values per key.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">f</span> <span class="nv">coll</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">coll</span>
</span><span class='line'>       <span class="c1">;; Create a mutable map of transient vectors.</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">map </span><span class="nv">value</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">k</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">value</span><span class="p">)</span>
</span><span class='line'>                       <span class="nv">items</span> <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">.get</span> <span class="o">^</span><span class="nv">java.util.HashMap</span> <span class="nb">map </span><span class="nv">k</span><span class="p">)</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nf">transient</span> <span class="p">[]))]</span>
</span><span class='line'>                   <span class="p">(</span><span class="nf">.put</span> <span class="o">^</span><span class="nv">java.util.HashMap</span> <span class="nb">map </span><span class="nv">k</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">items</span> <span class="nv">value</span><span class="p">)))</span>
</span><span class='line'>                 <span class="nv">map</span><span class="p">)</span>
</span><span class='line'>               <span class="p">(</span><span class="nf">java.util.HashMap.</span><span class="p">))</span>
</span><span class='line'>      <span class="c1">;; Make the vectors immutable into a transient map.</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">map </span><span class="p">[</span><span class="nb">key </span><span class="nv">value</span><span class="p">]]</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">assoc!</span> <span class="nb">map key </span><span class="p">(</span><span class="nf">persistent!</span> <span class="nv">value</span><span class="p">)))</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">transient</span> <span class="p">{}))</span>
</span><span class='line'>      <span class="c1">;; Make the map itself immutable.</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">persistent!</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is more efficient when there are many items that map to the same key in the returned map, since it uses transient values. (The Java HashMap turned out to be the fastest option to build the result here, but it never escapes this function.) This optimization cut some benchmark times in half. Combined with a number of smaller tweaks, this brought most of Clara&rsquo;s use cases inline with Drools performance. For other use cases Clara significantly outperforms Drools, but we&rsquo;ll get to those later.</p>

<p>My <code>tuned-group-by</code> function is faster than Clojure&rsquo;s <code>group-by</code> for some inputs and slower for others. But this misses a bigger advantage: <strong><em>Clojure&rsquo;s philosophy of separating functions and data made swapping implementations trivial, allowing users to pick the right ones for their specific needs.</em></strong> This isn&rsquo;t so easily done if functions are strongly tied to the data they work with, which is an easy pitfall of object-oriented programming.</p>

<h3>Referential Transparency Breeds Serendipity</h3>

<p>Writing functional code tends to create pleasant surprises. We come across significant advantages that wouldn&rsquo;t be possible with a different approach. Considering the following Clara example and it&rsquo;s Drools equivalent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">clara.benchmark.visit-order-same-day</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clara.rules</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clj-time.coerce</span> <span class="ss">:as</span> <span class="nv">coerce</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">clara.benchmark.beans</span> <span class="nv">Order</span> <span class="nv">Visit</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defquery</span> <span class="nv">same-day-visit</span>
</span><span class='line'>   <span class="s">&quot;Queries orders that occurred the same day as a visit.&quot;</span>
</span><span class='line'>   <span class="p">[]</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">Order</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?id</span> <span class="nv">customerId</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?day</span> <span class="p">(</span><span class="nf">coerce/to-local-date</span> <span class="nv">time</span><span class="p">))]</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">Visit</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?id</span> <span class="nv">customerId</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?day</span> <span class="p">(</span><span class="nf">coerce/to-local-date</span> <span class="nv">time</span><span class="p">))])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Drools equivalent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">clara</span><span class="o">.</span><span class="na">benchmark</span><span class="o">.</span><span class="na">drools</span><span class="o">.</span><span class="na">visit_order_same_day</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">clara.benchmark.beans.Order</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">clara.benchmark.beans.Visit</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">query</span> <span class="s">&quot;same_day_visit&quot;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Order</span><span class="o">(</span><span class="n">$id</span> <span class="o">:</span> <span class="n">customerId</span><span class="o">,</span> <span class="n">$day</span> <span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="na">toLocalDate</span><span class="o">())</span>
</span><span class='line'>   <span class="n">Visit</span><span class="o">(</span><span class="n">$id</span> <span class="o">==</span> <span class="n">customerId</span><span class="o">,</span> <span class="n">$day</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="na">toLocalDate</span><span class="o">())</span>
</span><span class='line'>
</span><span class='line'><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>These rules simply identify things happening on the same day. Yet there is a big difference: Drools does an O(n<sup>2</sup>) Cartesian join where Clara does an O(n*log<sub>32</sub>n) indexed join of each item. Therefore Clara becomes dramatically faster than Drools for large inputs in this case. Also notice how Clara cleanly integrates with Clojure&rsquo;s syntax, as opposed to embedding multiple syntaxes into a file, since it treats <a href="http://www.toomuchcode.org/blog/2013/09/24/rules-as-a-control-structure/">rules as a control structure</a>.</p>

<p>This is possible because of Clojure&rsquo;s emphasis on pure, referentially transparent functions. Since we can replace the function call with its result, we can build an index of that result. The outcome is a significantly more efficient system for this class of problem.</p>

<p>Along the same lines, rule engines facilities to reason over sets of facts can be implemented more efficiently under these constraints. Clara&rsquo;s equivalent of Jess and Drools <em>accumulators</em> simply compile into Clojure <a href="http://clojure.org/reducers">reducers</a>, making them more efficient than the alternatives by simply tapping into that feature.</p>

<p>These advantages arise often: we can defer computation to efficient batch operations. We can transparently spread work across threads without dealing with lock-based concurrency. We can memoize functions or build efficient caches based on fast reference comparison. Importantly, when starting a problem it&rsquo;s not always obvious how these advantages will arise, but these techniques provide an opportunity for great optimizations at the macro level. David Nolen&rsquo;s <a href="http://swannodette.github.io/2013/12/17/the-future-of-javascript-mvcs/">work on Om</a> is a dramatic example of this in action.</p>

<h2>The Trouble with Benchmarks</h2>

<p>X is faster than Y makes for a great incendiary headline on Hacker News, but it doesn&rsquo;t really make sense. X may be faster than Y for workload Z with trade offs A, B, and C&hellip;but for some reason those headlines don&rsquo;t get as many upvotes.</p>

<p>Benchmarks are informative and an important tool to improve our system. But they aren&rsquo;t a real measure of a system&rsquo;s quality or potential. A better measure is how easily a system can be understood, adapted, and expanded. If we can <em>understand</em> the nature of a problem, performance or otherwise, we can usually fix it. Clojure simply provides better mechanisms to understand and improve our systems than other languages I&rsquo;ve used.</p>

<p>In short, the trouble with benchmarks is they encourage treating symptoms rather the than the explosion of complexity that limits what we can build.</p>

<h2>Clara&rsquo;s Future</h2>

<p>All optimizations discussed here are in master and will be released in Clara 0.6.0 this summer. You can see some current comparisons with Drools in the <a href="https://github.com/rbrush/clara-benchmark">clara-benchmark project</a>. There are still opportunities for improvement in Clara, being a relatively new system. Probably the next significant optimization is greater laziness, <a href="https://github.com/rbrush/clara-rules/issues/58">which we&rsquo;re tracking here</a>.</p>

<p>Updates will be posted here and on <a href="https://twitter.com/ryanbrush">my twitter feed</a>. I&rsquo;ll also be discussing modern approaches to expert systems, including Clara, at two conferences over the next few months: <a href="http://www.midwest.io">Midwest.io</a> in July and <a href="https://thestrangeloop.com">strangeloop</a> in September.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/17/clara-0-dot-5-released/">Clara 0.5 Released</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Clara 0.5 has been released! This is mostly a big fix release with some usability improvements. See the <a href="https://github.com/rbrush/clara-rules/blob/master/CHANGELOG.md">changelog</a> and the <a href="https://github.com/rbrush/clara-rules">github page</a> for usage information.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/06/clara-0-dot-4-released/">Clara 0.4 Released</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Clara 0.4 has been released, and is available on Clojars! See the <a href="https://github.com/rbrush/clara-rules">github page</a> for usage information. I wrote about the significant features in the <a href="/blog/2014/01/19/rules-as-data/">Rules as Data</a> post.</p>

<p>The <a href="https://groups.google.com/forum/#!topic/clojure/bvs9zQMDpNg">release announcement</a> is in the Clojure Google Group.</p>

<p>This release puts Clara on a strong footing, and I&rsquo;m looking forward to playing with the new rules-as-data features.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/19/rules-as-data/">Rules as Data</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content">This started as a topic for a&nbsp;<a href="http://www.meetup.com/lamba-lounge-kc/" target="_blank">Lambda Lounge</a>&nbsp;meetup but seems worth sharing broadly.<br />I&#8217;ve posted previously about treating <a href="http://www.toomuchcode.org/2013/09/rules-as-control-structure.html" target="_blank">rules as a control structure</a>, but for <a href="https://github.com/rbrush/clara-rules" target="_blank">Clara 0.4</a> rules are now first-class data structures with well-defined schema. &nbsp;The simple <i>defrule</i>&nbsp;syntax is preserved but the macro now produces a data structure that is used everywhere else. For example, the following code:<br />

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrule</span> <span class="nv">date-too-early</span>
</span><span class='line'>  <span class="s">&quot;We can&#39;t schedule something too early.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">WorkOrder</span> <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">weeks-until</span> <span class="nv">date</span><span class="p">)</span> <span class="mi">2</span><span class="p">)]</span>
</span><span class='line'>  <span class="nv">=&gt;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insert!</span> <span class="p">(</span><span class="nf">-&gt;ApprovalRequired</span> <span class="ss">:timeline</span> <span class="s">&quot;Date is too early&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

Defines a var containing this structure:<br />
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:doc</span> <span class="s">&quot;We can&#39;t schedule something too early.&quot;</span>,
</span><span class='line'> <span class="ss">:name</span> <span class="s">&quot;date-too-early&quot;</span>,
</span><span class='line'> <span class="ss">:lhs</span>
</span><span class='line'> <span class="p">[{</span><span class="ss">:constraints</span> <span class="p">[(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">llkc.example/weeks-until</span> <span class="nv">date</span><span class="p">)</span> <span class="mi">2</span><span class="p">)]</span>,
</span><span class='line'>   <span class="ss">:type</span> <span class="nv">llkc.example.WorkOrder</span><span class="p">}]</span>,
</span><span class='line'> <span class="ss">:rhs</span>
</span><span class='line'> <span class="p">(</span><span class="nf">clara.rules/insert!</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">llkc.example/-&gt;ApprovalRequired</span> <span class="ss">:timeline</span> <span class="s">&quot;Date is too early&quot;</span><span class="p">))}</span>
</span></code></pre></td></tr></table></div></figure>

The rule structure itself is <a href="https://github.com/rbrush/clara-rules/blob/master/src/main/clojure/clara/rules/schema.clj#L50" target="_blank">defined in Clara&#8217;s schema</a>, and simply stored in the var with the rule&#8217;s name.<br /><br />So, now that rules are data, we open the door to tooling to explore and manipulate them. For instance, we can visualize the relationship between rules. Here is a visualization of the <a href="https://github.com/rbrush/presentations/blob/master/llkc-2014-jan/src/llkc/example.clj" target="_blank">rules used for the meetup</a>. I arbitrarily chose shapes to distinguish the different types of data:<br /><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="/images/rules-as-data-logic.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="/images/rules-as-data-logic-small.png" /></a></div><br /><br />This image is generated by running the following <a href="https://github.com/rbrush/clara-rules/blob/master/src/main/clojure/clara/tools/viz.clj" target="_blank">function from clara.tools.viz</a> against <a href="https://github.com/rbrush/presentations/blob/master/llkc-2014-jan/src/llkc/example.clj" target="_blank">the example used at the meetup</a>:<br />

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">viz/show-logic!</span> <span class="ss">&#39;llkc.example</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

That function simply scans each rule in the given namespace, reads individual conditions from the rule data structure, and wires them up. The graph itself is rendered with GraphViz.<br /><br />Since all rules of data, they can be filtered or manipulated like any Clojure data structure. So here we take our set of rules and only display those that handle logic for validation errors:<br />

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">viz/show-logic!</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nf">viz/inserts?</span> <span class="nv">%</span> <span class="nv">ValidationError</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">viz/get-productions</span> <span class="p">[</span><span class="ss">&#39;llkc.example</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>

In this example there is only one rule that does validation, so the resulting image looks like this:<br /><div class="separator" style="clear: both; text-align: center;"><a href="/images/rules-as-data-valid.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="/images/rules-as-data-valid.png" height="169" width="320" /></a></div><br /><h2>Rule engine as an API</h2>The rules-as-data model creates another significant advantage: we have decoupled the DSL-style syntax from the rule engine itself. Clara users can now create rules from arbitrary sources, such as a specialized syntax, an external database, or domain-specific file format. (Think <a href="https://github.com/Engelberg/instaparse" target="_blank">instaparse</a> tied to rule generation.) Clara is evolving into a general Rete engine, with its &#8220;defrule&#8221; syntax being just one way to use it.<br /><br />So far I&#8217;ve written only simple, GraphViz-based visualizations but we can expose these with more sophisticated UIs. Projecting such visualizations onto, say, a D3-based graph could provide a rich, interactive way of exploring logic.<br /><br />At this point, <a href="https://github.com/rbrush/clara-rules" target="_blank">Clara 0.4 is available as snapshot builds</a>. I expect to do a release in February, pending some cleanup and enhancements to ClojureScript support. I&#8217;ll post updates on my twitter feed, <a href="https://twitter.com/ryanbrush" target="_blank">@ryanbrush</a>.</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/09/crossing-the-data-streams-scalable-realtime-processing-with-rules/">Crossing the (data) streams&#58; scalable realtime processing with rules</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content">Pipe-and-filter architectures are among the most successful design patterns ever. They dominate data ingestion and processing today, and give 1970&#8217;s hackers yet another chance to remind us how they thought of everything years ago.<br /><br />Unfortunately modern variations of this can run into an ugly problem: what are the semantics of a &#8220;join&#8221; operation between multiple infinite streams of data? Popular systems like Storm <a href="https://github.com/nathanmarz/storm/wiki/Common-patterns" target="_blank">point out this ambiguity</a>, <a href="http://samza.incubator.apache.org/learn/documentation/0.7.0/container/state-management.html" target="_blank">as does Samza</a>. Both provide primitives to support correlation of events between streams, but the higher-level semantics of a join are punted to the user.

<br /><br />This is fine for such systems providing infrastructure, but is a troublesome model of our applications: if we can&#8217;t define clear and compelling semantics for a key part of our processing model, we might be using the wrong model. Projects like Storm offer an excellent infrastructure, but this ambiguity implies that many problems could be solved with a higher-level abstraction.<br /><br />The challenge with user-defined join semantics is it comes with baggage: maintaining state, structuring it, and recovering state after failure scenarios are challenging problems. It also makes the behavior of the system harder to understand. Since each join can have slightly different behavior, we need to look closely to see what&#8217;s going on. A better approach is needed. A set of simple yet flexible join operators would be ideal &#8211; so how do we get there?<br /><br />

<blockquote class="tr_bq"><div style="text-align: center;"><span style="font-size: large;"><i>If we can&#8217;t define clear and compelling semantics for a key part of our processing model, we might be using the wrong model.</i></span></div></blockquote>

We might consider CEP-style systems such as Esper and Drools Fusion, which have been tackling declarative-style joins for years. But such systems don&#8217;t offer the scalability or processing guarantees of Storm, and they use limited languages that aren&#8217;t always expressive enough for sophisticated logic.<br /><br />We need a data processing model with well-defined, declarative joins while supporting rich application logic. There are lots of options here, but here I&#8217;ll focus on one: suppose we could make&nbsp;<a href="http://www.toomuchcode.org/2013/09/rules-as-control-structure.html" target="_blank">rules as a control structure</a>&nbsp;scale linearly across a cluster, letting the rules engine distribute join operations. Let&#8217;s look at an experiment of making <a href="https://github.com/rbrush/clara-rules" target="_blank">Clara, a Clojure-based rules engine</a>, distribute its working memory and processing across a Storm cluster, with all of the scalability and processing guarantees of the underlying system.<br /><br /><h3>Forward-chaining rules on Storm</h3>Imagine a variant of the <a href="http://en.wikipedia.org/wiki/Rete_algorithm" target="_blank">Rete algorithm</a> implemented with some simple constraints:<br /><br />First, each condition in a rule can be evaluated independently, so incoming data can be spread across an arbitrary number of processes and match rule conditions appropriately.<br /><br />Second, aggregations over matched facts follow a map-and-reduce style pattern &#8211; where the map and partial reductions of aggregated facts can be done in parallel across machines.<br /><br />Finally, &#8220;joins&#8221; of aggregations or individual facts are always hash-based. So joins can be efficiently achieved by sending matched facts to the same node via their hash values.<br /><br />The result is our Storm topology looks something like this:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-f_frwIKZjko/Un0YiMW56jI/AAAAAAAAAIE/5GotL58ac28/s1600/clara-storm-diagram.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="210" src="http://4.bp.blogspot.com/-f_frwIKZjko/Un0YiMW56jI/AAAAAAAAAIE/5GotL58ac28/s320/clara-storm-diagram.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><span style="text-align: left;"><br /></span></div><div class="separator" style="clear: both; text-align: justify;"><span style="text-align: left;">Let&#8217;s consider a simple example. Suppose we have feeds of temperature readings from multiple locations in some facility, and we want to take action in those locations should our readings exceed a threshold.</span></div><br />Each temperature reading has a logical timestamp, so since our logic is interested in the &#8220;newest&#8221; reading, we use a <a href="https://github.com/rbrush/clara-rules/wiki/Accumulators" target="_blank">Clara accumulator</a> that selects the item with the newest timestamp:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">newest-temp</span> <span class="p">(</span><span class="nf">acc/max</span> <span class="ss">:timestamp</span> <span class="ss">:returns-fact</span> <span class="nv">true</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

We then use it in a rule that processes all our readings for a location and preserves the newest:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrule</span> <span class="nv">get-current-temperature</span>
</span><span class='line'>  <span class="s">&quot;Get the current temperature at a location by simply </span>
</span><span class='line'><span class="s">   looking at the newest reading.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">?current-temp</span> <span class="nv">&lt;-</span> <span class="nv">newest-temp</span> <span class="ss">:from</span> <span class="p">[</span><span class="nv">TemperatureReading</span> <span class="p">(</span><span class="nb">== </span><span class="nv">?location</span> <span class="nv">location</span><span class="p">)]]</span>
</span><span class='line'>  <span class="nv">=&gt;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insert!</span> <span class="p">(</span><span class="nf">-&gt;CurrentTemperature</span> <span class="p">(</span><span class="ss">:value</span> <span class="nv">?current-temp</span><span class="p">)</span> <span class="nv">?location</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

Note that accumulators preserve minimal state and apply changes incrementally. In this case we keep only the current temperature based on timestamp; lower values are simply discarded, so we can deal with an infinite stream. &nbsp;Also, this example keeps the maximum, but we could easily accumulate some other value, such as a time-weighted histogram of temperatures to we&#8217;re robust to outliers. Any fact that doesn&#8217;t match a rule is simply discarded, incurring no further cost.<br /><br />Now that we have the current temperature for each location, we want to back off our devices in those locations if a threshold is exceeded. We can write this as a simple rule as well:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrule</span> <span class="nv">reduce-device-speed</span>
</span><span class='line'>  <span class="s">&quot;Reduce the speed of all devices in a location that has a high temperature.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">CurrentTemperature</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">value</span> <span class="nv">high-threshold</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">(</span><span class="nb">= </span><span class="nv">?location-id</span> <span class="nv">location</span><span class="p">)]</span>
</span><span class='line'>  <span class="c1">;; Find all Device records in the location, and bind them to the ?device variable.</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">?device</span> <span class="nv">&lt;-</span> <span class="nv">Device</span> <span class="p">(</span><span class="nb">= </span><span class="nv">?location-id</span> <span class="nv">location</span><span class="p">)]</span>
</span><span class='line'>  <span class="nv">=&gt;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">reduce-speed!</span> <span class="nv">?device</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

This first condition matches current temperatures that exceed the threshold, and binds it the ?location-id variable. &nbsp;The second condition finds all devices with a matching location, and binds them to the ?device variable. &nbsp;This is then visible on the right-hand side of the rule, where we can take action.<br /><br />This is effectively performing a join between temperatures that exceeded a threshold at a given location and devices in that same location. When running over Storm, this rule wish hash Device and CurrentTemperature facts and send them to the same processing using a hash value. This is done using Storm&#8217;s group-by field functionality over a data stream that connects each bolt instance together.<br /><br />All state for the join operations are managed internally by Clara&#8217;s engine. Accumulators like the example here compute in a rolling fashion, merging new data together, retracting previously accumulated values, and inserting new ones. Combined with rule engine-style truth maintenance, developers can simply declare their logic and let the engine maintain state and consistency.<br /><br /><h3>Integration with Processing Topologies</h3>The <a href="https://github.com/rbrush/clara-examples/blob/master/src/main/clojure/clara/examples/sensors.clj" target="_blank">rules used in this example are here</a>, and are run with the <a href="https://github.com/rbrush/clara-examples/blob/master/src/main/clojure/clara/examples/storm.clj" target="_blank">Storm launching code here</a>. There is also a draft <a href="https://github.com/rbrush/clara-storm/blob/master/src/main/java/clara/storm/RuleBolts.java" target="_blank">Java API to attach rules to a topology</a>. Note that our approach is to simply attach to a Storm topology defined via a provided TopologyBuilders, so users can pre-process or perform other logic in their topology, and route data as appropriate into the distributed rule engine. Also, these examples use Clojure records, but they can work equally well with Java objects, including ones generated by Thrift, Avro, or Protocol Buffers.<br /><br /><h3>Current State</h3>A prototype of rules over Storm is in the <a href="https://github.com/rbrush/clara-storm" target="_blank">clara-storm project</a>. It also includes the abilities to run queries across the rule engine&#8217;s working memory, using Storm&#8217;s Distributed RPC mechanism. A handful of things need to come together to make this production ready, inluding:<br /><br /><ul><li>I&#8217;d like input and suggestions from members of the Storm community. This topology layout isn&#8217;t an idiomatic use of Storm, so we need to ensure this won&#8217;t run into problems as we scale. &nbsp;(This is one of the reasons I&#8217;m posting this now.)</li><li>The <a href="https://github.com/rbrush/clara-rules/issues/16" target="_blank">ability to persist Clara&#8217;s working memory</a> to recover from machine failures. This will probably take the form of writing state changes for each rule node to reliable write-ahead log, with Kafka being a good storage mechanism.</li><li>Optimizations ranging from efficient serialization to doing partial aggregations prior to sharing state between bolts are needed.</li><li>Consider temporal operators in Clara. Accumulators have worked well to this point but may run into limits.</li><li>Testing at scale!</li></ul><div>The biggest takeaway is how technologies like Storm and Clojure provide an opportunity to express computation with higher-level abstractions. Things like <a href="https://blog.twitter.com/2013/streaming-mapreduce-with-summingbird" target="_blank">SummingBird</a>&nbsp;(and Cascalog 2.0?) offer ways to query data streams. These could be complemented by support for forward-chaining rules for problems easily expressed that way.</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/24/rules-as-a-control-structure/">Rules as a Control Structure</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content">Rule engines seem to draw love-or-hate reactions. On one hand they offer a simple way to manage lots of arbitrary, complex, frequently-changing business logic. On the other, their simplicity often comes with limitations, and edge cases pop up that can&#8217;t be elegantly solved in the confines of rules. There are few things more frustrating than a tool meant to help you solve problems actually creates them.<br /><br />The tragedy is that excellent ideas for modeling logic with rules have been hijacked by a myth: that it&#8217;s &nbsp;possible to <i>write code</i>&nbsp;&#8211; to unambiguously define logic in a textual form &#8211;<i>&nbsp;without actually writing code.</i>&nbsp;We see authoring tools generating rules in limited languages (or XML!), making the case that domain experts can author logic without development expertise. The shortage of good developers makes this tremendously appealing, and this demand has drawn supply.

<br /><br />If you have a limited problem space satisfied by such tools, then great. But problems remain:<br /> <br />

<ul>
<li>Limited problem spaces often don&#8217;t stay limited.</li>
<li>Many problems involving arbitrary domain knowledge are best solved with rules when we can, but require the ability to integrate with a richer programming environment when we must.</li>
</ul>

<div>So how do we approach this? We need to stop thinking of rule engines as external systems that create artificial barriers between our logic, but as first-class constructs seamlessly integrated in the host language. &nbsp;In other words, rules engines are best viewed as an <i>alternate control structure</i>, suited to the business problem at hand.<br /><br />Clojure is uniquely positioned to tackle this problem. Macros make sophisticated alternate control structures possible, Clojure&#8217;s rich data structures make it suitable for solving many classes of problems, and its JVM integration makes it easy to plug into many systems. This is the idea behind <a href="https://github.com/rbrush/clara-rules">Clara</a>, a forward-chaining rules implementation in pure Clojure.</div><div><br /></div><div>Here&#8217;s an example from the <a href="https://github.com/rbrush/clara-rules/wiki/Introduction">Clara documentation</a>. &nbsp;In a retail setting with many arbitrary frequently promotions, we might author them like this:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrule</span> <span class="nv">free-lunch-with-gizmo</span>
</span><span class='line'>  <span class="s">&quot;Anyone who purchases a gizmo gets a free lunch.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">Purchase</span> <span class="p">(</span><span class="nb">= </span><span class="nv">item</span> <span class="ss">:gizmo</span><span class="p">)]</span>
</span><span class='line'>  <span class="nv">=&gt;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insert!</span> <span class="p">(</span><span class="nf">-&gt;Promotion</span> <span class="ss">:free-lunch-with-gizmo</span> <span class="ss">:lunch</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

And create a query to retrieve promotions:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defquery</span> <span class="nv">get-promotions</span>
</span><span class='line'>  <span class="s">&quot;Query to find promotions for the purchase.&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">?promotion</span> <span class="nv">&lt;-</span> <span class="nv">Promotion</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>

All of this is usable with idiomatic Clojure code:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">mk-session</span> <span class="ss">&#39;clara.examples.shopping</span><span class="p">)</span> <span class="c1">; Load the rules.</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">-&gt;Customer</span> <span class="ss">:vip</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">-&gt;Order</span> <span class="mi">2013</span> <span class="ss">:march</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">20</span> <span class="ss">:gizmo</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">120</span> <span class="ss">:widget</span><span class="p">))</span> <span class="c1">; Insert some facts.</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">fire-rules</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">query</span> <span class="nv">get-promotions</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

The resulting query returns the matching promotions. More sophisticated examples may join multiple facts and query by parameters; see the <a href="https://github.com/rbrush/clara-rules/wiki/Guide">developer guide</a> or the &nbsp;<a href="https://github.com/rbrush/clara-examples">clara-examples project</a> for more.<br /><br />Each rule constraint and action &#8211; the left-hand and right-hand sides &#8211; are simply Clojure expressions that can contain arbitrary logic. We also benefit from other advantages of Clojure. For instance, Clara&#8217;s working memory is an immutable, persistent data structure. Some of the advantages of that may come in a later post.<br /><h2>Rules by domain experts</h2><div>So we&#8217;ve broken down some traditional barriers in rule engines, but it seems like this approach comes with a downside: by making rules a control structure in high-level languages, are we excluding non-programmer domain experts from authoring them?<br /><br />We can expand our rule authoring audience in a couple ways:<br /><br />

<div>
<ol>
<li>Encapsulate rules into their own files editable by domain experts, yet compiled into the rest of the system. An audience savvy enough to work with, say, Drools can understand the above examples and many others.</li>
<li>Generate rules from higher-level, domain-specific macros. Business logic could be modeled in a higher-level declarative structure that creates the rules at compile time. Generating rules is actually simpler than most logic generation, since rule ordering and truth maintenance are handled by the engine itself.</li>
<li>Tooling to generate rules directly or indirectly. Like all Lisp code, these rules are also data structures. In fact, they are simpler to work with than an arbitrary s-expression because they offer more structure: a set of facts used by simple constraints resulting in an action, which could also contribute more knowledge to the session&#8217;s working memory.&nbsp;</li></ol>
</div>
<div>Ultimately, all of this results in Clojure code that plugs directly into a rich ecosystem.&nbsp;</div><div><br /></div><div>These options will be fun to explore, but this isn&#8217;t my initial target. Let&#8217;s first create a useful tool for expressing complex logic in Clojure. Hopefully this will become a basis for exploration,&nbsp;borrowing good ideas for expressing business rules and making them available in many environments via the best Lisp available.</div><div><br /></div></div>If this seems promising, check out the <a href="https://github.com/rbrush/clara-rules">Clara project on github</a> for more. I&#8217;ll also post updates on twitter at @ryanbrush.<br /><br />Update: see the <a href="https://groups.google.com/forum/#!topic/clojure/pfeFyZkoRdU">Clojure Google Group</a> for some discussion on this topic.<br /><br /></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/18/a-long-time-ago-we-used-to-be-friends/">A long time ago, we used to be friends</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content">No one ever intends to let their blogs go dark, but here we are. &nbsp;I&#8217;m planning on dusting off this blog to write about some new personal projects, but for now I thought I&#8217;d link to writing I&#8217;ve done in other venues:

<br /><br />I&#8217;ve written a few posts for <a href="https://engineering.cerner.com/">Cerner&#8217;s Engineering blog</a> as part of my work at Cerner. These include:<br /><ul><li><a href="https://engineering.cerner.com/2013/02/composable-mapreduce-with-hadoop-and-crunch/">Composable MapReduce with Hadoop and Crunch</a></li><li><a href="https://engineering.cerner.com/2013/02/near-real-time-processing-over-hadoop-and-hbase/">Near Real-time Processing Over Hadoop and HBase</a></li><li><a href="https://engineering.cerner.com/2013/07/thinking-in-mapreduce/">Thinking in MapReduce</a></li></ul><div>Some of this content is from talks that I&#8217;ve given at Hadoop World, ApacheCon, and StampedeCon.<br /><br />Some ideas originally posted to this blog have been published in the book <a href="http://www.amazon.com/Things-Every-Programmer-Should-Know/dp/B00CVDXWV8">97 Things Every Programmer Should Know</a>. <br /><br />My latest personal project has been the construction of a <a href="https://github.com/rbrush/clara-rules">forward-chaining rules engine in Clojure</a>. I expect this and related problems to be the emphasis on this blog moving forward.</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/11/27/start-by-embracing-your-limits/">Start by embracing your limits</a></h1>
    
    
      <p class="meta">
        





        
        
      </p>
    
  </header>


  <div class="entry-content"><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; background-color: transparent; font-family: Times; font-size: medium; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Nothing in human history has offered more promise but has seen as many failures as software.  We’ve all seen moments of greatness, where a program seems like magic &#8211; but such gems are surrounded by minefields of bugs and indecipherable interfaces.</span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">The result of all this is we programmers are often a frustrated bunch. But should we be? After all, what makes us think that as a species we should have the aptitude to create great software?  Our skill sets evolved in an environment that favored those who could hunt boar and find berries &#8211; any capacity to succeed in the abstract world of software is pure, accidental side effect.  Perhaps we should be awed by software’s successes rather than frustrated by its failures.</span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">The good news is we can improve despite our limitations, and it starts with this: accept that we generally have no innate ability to create great systems, and design our practices around that.  It seems like </span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">every</span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> major step forward in software has followed this pattern of embracing our limitations.  For instance, we move to iterative development since we can’t anticipate all variables of a project.  We aggressively unit test because we realize we’re prone to error. Libraries derived from practical experience frequently replace those built by expert groups.   The list goes on.</span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">This type of admission is humbling, but it can also be liberating.  Here’s an example: In years past I would spend hours agonizing over an internal design decision for a system I was building.  I figured if I got it right we could easily bolt on some new feature.  Sometimes I was right, but often times I was not.  My code often was littered with unnecessary structure that only made things more complicated.</span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Contrast that to today:  I know I can’t anticipate future needs in most cases, so I just apply this simple heuristic: </span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><ol><li style="list-style-type: decimal; font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">When in doubt, do the simplest thing possible to solve the problem at hand</span></li><li style="list-style-type: decimal; font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Plan on refactoring later.</span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> </span></li></ol><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">The first step frees us from trying to anticipate all future needs &#8211; but this is not quick and dirty cowboy coding.  An essential element of code is to create an understandable and maintainable system.  Don&#8217;t try to code for future needs.  Instead, structure code for present needs so it can be leveraged in the future.  </span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">So how do we do this? A couple things to keep in mind:</span><br /><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><ul><li style="list-style-type: disc; font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">When in doubt, leave it out. (also known as “You Ain’t Gonna Need It”)</span></li><li style="list-style-type: disc; font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Unit-Testable designs tend to be reusable designs.  Unit tests not only catch bugs that can result from refactoring, but they encourage modularity to enable that refactoring.</span></li><li style="list-style-type: disc; font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Don’t try to design an API independently of an application.  You won’t understand your users’ needs well enough to create a good experience.   Build the API as part of the application to make sure its needs are met, then factor out and generalize.</span></li><li style="list-style-type: disc; font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; "><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Group code together that tends to change for similar reasons.  If your Widget class is responsible for rendering its UI </span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">and</span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> writing to the database </span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">and</span><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> business logic, you can’t use it anywhere else without significant changes.  High cohesion and loose coupling.</span></li></ul><span style="font-size: 11pt; font-family: Arial; color: rgb(0, 0, 0); background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">There are no hard-and-fast rules to building software, but we all need a compass to help guide us through the thousands of micro-decisions we make every time we write code.  Hopefully this post can help build that compass.</span></div></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section><h1>Twitter</h1>
<a class="twitter-timeline" href="https://twitter.com/ryanbrush" data-widget-id="477774048554795009">Tweets by @ryanbrush</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Ryan Brush -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
