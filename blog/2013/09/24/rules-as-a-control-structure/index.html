
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Rules as a Control Structure - Too Much Code</title>
  <meta name="author" content="Ryan Brush">

  
  <meta name="description" content="Rule engines seem to draw love-or-hate reactions. On one hand they offer a simple way to manage lots of arbitrary, complex, frequently-changing &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.toomuchcode.org/blog/2013/09/24/rules-as-a-control-structure/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Too Much Code" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2927953-1']);
    _gaq.push(['_setDomainName','toomuchcode.org']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Too Much Code</a></h1>
  
    <h2>Not enough cohesion</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.toomuchcode.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Rules as a Control Structure</h1>
      
    
    
      <p class="meta">
        








  



  
<time datetime="2013-09-24T11:47:12Z" pubdate data-updated="true">Sep 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content">Rule engines seem to draw love-or-hate reactions. On one hand they offer a simple way to manage lots of arbitrary, complex, frequently-changing business logic. On the other, their simplicity often comes with limitations, and edge cases pop up that can&#8217;t be elegantly solved in the confines of rules. There are few things more frustrating than a tool meant to help you solve problems actually creates them.<br /><br />The tragedy is that excellent ideas for modeling logic with rules have been hijacked by a myth: that it&#8217;s &nbsp;possible to <i>write code</i>&nbsp;&#8211; to unambiguously define logic in a textual form &#8211;<i>&nbsp;without actually writing code.</i>&nbsp;We see authoring tools generating rules in limited languages (or XML!), making the case that domain experts can author logic without development expertise. The shortage of good developers makes this tremendously appealing, and this demand has drawn supply.

<br /><br />If you have a limited problem space satisfied by such tools, then great. But problems remain:<br /> <br />

<ul>
<li>Limited problem spaces often don&#8217;t stay limited.</li>
<li>Many problems involving arbitrary domain knowledge are best solved with rules when we can, but require the ability to integrate with a richer programming environment when we must.</li>
</ul>

<div>So how do we approach this? We need to stop thinking of rule engines as external systems that create artificial barriers between our logic, but as first-class constructs seamlessly integrated in the host language. &nbsp;In other words, rules engines are best viewed as an <i>alternate control structure</i>, suited to the business problem at hand.<br /><br />Clojure is uniquely positioned to tackle this problem. Macros make sophisticated alternate control structures possible, Clojure&#8217;s rich data structures make it suitable for solving many classes of problems, and its JVM integration makes it easy to plug into many systems. This is the idea behind <a href="https://github.com/rbrush/clara-rules">Clara</a>, a forward-chaining rules implementation in pure Clojure.</div><div><br /></div><div>Here&#8217;s an example from the <a href="https://github.com/rbrush/clara-rules/wiki/Introduction">Clara documentation</a>. &nbsp;In a retail setting with many arbitrary frequently promotions, we might author them like this:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrule</span> <span class="nv">free-lunch-with-gizmo</span>
</span><span class='line'>  <span class="s">&quot;Anyone who purchases a gizmo gets a free lunch.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">Purchase</span> <span class="p">(</span><span class="nb">= </span><span class="nv">item</span> <span class="ss">:gizmo</span><span class="p">)]</span>
</span><span class='line'>  <span class="nv">=&gt;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insert!</span> <span class="p">(</span><span class="nf">-&gt;Promotion</span> <span class="ss">:free-lunch-with-gizmo</span> <span class="ss">:lunch</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

And create a query to retrieve promotions:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defquery</span> <span class="nv">get-promotions</span>
</span><span class='line'>  <span class="s">&quot;Query to find promotions for the purchase.&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">?promotion</span> <span class="nv">&lt;-</span> <span class="nv">Promotion</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>

All of this is usable with idiomatic Clojure code:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">mk-session</span> <span class="ss">&#39;clara.examples.shopping</span><span class="p">)</span> <span class="c1">; Load the rules.</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">-&gt;Customer</span> <span class="ss">:vip</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">-&gt;Order</span> <span class="mi">2013</span> <span class="ss">:march</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">20</span> <span class="ss">:gizmo</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">-&gt;Purchase</span> <span class="mi">120</span> <span class="ss">:widget</span><span class="p">))</span> <span class="c1">; Insert some facts.</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">fire-rules</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">query</span> <span class="nv">get-promotions</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

The resulting query returns the matching promotions. More sophisticated examples may join multiple facts and query by parameters; see the <a href="https://github.com/rbrush/clara-rules/wiki/Guide">developer guide</a> or the &nbsp;<a href="https://github.com/rbrush/clara-examples">clara-examples project</a> for more.<br /><br />Each rule constraint and action &#8211; the left-hand and right-hand sides &#8211; are simply Clojure expressions that can contain arbitrary logic. We also benefit from other advantages of Clojure. For instance, Clara&#8217;s working memory is an immutable, persistent data structure. Some of the advantages of that may come in a later post.<br /><h2>Rules by domain experts</h2><div>So we&#8217;ve broken down some traditional barriers in rule engines, but it seems like this approach comes with a downside: by making rules a control structure in high-level languages, are we excluding non-programmer domain experts from authoring them?<br /><br />We can expand our rule authoring audience in a couple ways:<br /><br />

<div>
<ol>
<li>Encapsulate rules into their own files editable by domain experts, yet compiled into the rest of the system. An audience savvy enough to work with, say, Drools can understand the above examples and many others.</li>
<li>Generate rules from higher-level, domain-specific macros. Business logic could be modeled in a higher-level declarative structure that creates the rules at compile time. Generating rules is actually simpler than most logic generation, since rule ordering and truth maintenance are handled by the engine itself.</li>
<li>Tooling to generate rules directly or indirectly. Like all Lisp code, these rules are also data structures. In fact, they are simpler to work with than an arbitrary s-expression because they offer more structure: a set of facts used by simple constraints resulting in an action, which could also contribute more knowledge to the session&#8217;s working memory.&nbsp;</li></ol>
</div>
<div>Ultimately, all of this results in Clojure code that plugs directly into a rich ecosystem.&nbsp;</div><div><br /></div><div>These options will be fun to explore, but this isn&#8217;t my initial target. Let&#8217;s first create a useful tool for expressing complex logic in Clojure. Hopefully this will become a basis for exploration,&nbsp;borrowing good ideas for expressing business rules and making them available in many environments via the best Lisp available.</div><div><br /></div></div>If this seems promising, check out the <a href="https://github.com/rbrush/clara-rules">Clara project on github</a> for more. I&#8217;ll also post updates on twitter at @ryanbrush.<br /><br />Update: see the <a href="https://groups.google.com/forum/#!topic/clojure/pfeFyZkoRdU">Clojure Google Group</a> for some discussion on this topic.<br /><br /></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ryan Brush</span></span>

      








  



  
<time datetime="2013-09-24T11:47:12Z" class="updated">Updated Sep 24<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.toomuchcode.org/blog/2013/09/24/rules-as-a-control-structure/" data-via="ryanbrush" data-counturl="http://www.toomuchcode.org/blog/2013/09/24/rules-as-a-control-structure/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2013/08/18/a-long-time-ago-we-used-to-be-friends/" title="Previous Post: A long time ago, we used to be friends">&laquo; A long time ago, we used to be friends</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2013/11/09/crossing-the-data-streams-scalable-realtime-processing-with-rules/" title="Next Post: Crossing the (data) streams&#58; scalable realtime processing with rules">Crossing the (data) streams&#58; scalable realtime processing with rules &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/11/11/clara-rules-site/">Clara Rules Site</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/16/micro-bench-macro-optimize/">Micro Benchmarks versus Macro Optimizations in Clojure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/17/clara-0-dot-5-released/">Clara 0.5 Released</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/06/clara-0-dot-4-released/">Clara 0.4 Released</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/19/rules-as-data/">Rules as Data</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/rbrush">@rbrush</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'rbrush',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section><h1>Twitter</h1>
<a class="twitter-timeline" href="https://twitter.com/ryanbrush" data-widget-id="477774048554795009">Tweets by @ryanbrush</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Ryan Brush -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
